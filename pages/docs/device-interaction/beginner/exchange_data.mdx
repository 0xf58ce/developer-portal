import { Callout } from "nextra/components";

# Exchange data with the device

## Overview

This tutorial demonstrates how to send and receive data from a Ledger device using Application Protocol Data Units (APDUs). We'll explore both direct APDU handling and using pre-defined commands for ease of use.

## Prerequisites

Make sure you have a connected device session ID available from the previous connection tutorial.

## Sending an APDU

### Recommended Practices

<Callout> 
  Whenever possible, use [pre-defined commands](#sending-a-pre-defined-command) or [custom build commands](#building-a-new-command) rather than dealing with APDUs directly. This approach enhances code reusability and maintainability.
</Callout>

### Step 1: Building the APDU

To construct an APDU, use `ApduBuilder`. Here's an example for opening the Bitcoin app:

```ts
import { ApduBuilder } from "@ledgerhq/device-management-kit";

const openAppApduArgs = { cla: 0xe0, ins: 0xd8, p1: 0x00, p2: 0x00 };
const apdu = new ApduBuilder(openAppApduArgs)
  .addAsciiStringToData("Bitcoin")
  .build();
```
### Step 2: Sending the APDU

Send the constructed APDU using the `sdk.sendApdu` method:

```ts
const apduResponse = await sdk.sendApdu({ sessionId, apdu });
```
### Step 3: Parsing the Response

Parse the response using `ApduParser` and check for success:

```ts
import { ApduParser, CommandUtils } from "@ledgerhq/device-management-kit";

const parser = new ApduParser(apduResponse);

if (!CommandUtils.isSuccessResponse(apduResponse)) {
  throw new Error(
    `Unexpected status word: ${parser.encodeToHexaString(apduResponse.statusCode)}`,
  );
}
```

## Sending a Pre-defined Command

For convenience, pre-defined commands simplify APDU building and response parsing.

### Open App

Opens the specified app on the device:

```ts
import { OpenAppCommand } from "@ledgerhq/device-management-kit";

const command = new OpenAppCommand("Bitcoin");
await sdk.sendCommand({ sessionId, command });
```

### Close App

Closes the currently open app:

```ts
import { CloseAppCommand } from "@ledgerhq/device-management-kit";

const command = new CloseAppCommand();
await sdk.sendCommand({ sessionId, command });
```

### Get OS Version

Fetches the OS version information:

```ts
import { GetOsVersionCommand } from "@ledgerhq/device-management-kit";

const command = new GetOsVersionCommand();
const { seVersion, mcuSephVersion, mcuBootloaderVersion } = await sdk.sendCommand({ sessionId, command });
```

### Get App and Version

Retrieves the current app name and version:

```ts
import { GetAppAndVersionCommand } from "@ledgerhq/device-management-kit";

const command = new GetAppAndVersionCommand();
const { name, version } = await sdk.sendCommand({ sessionId, command });
```

## Device Actions

Device actions consist of sequences of commands that often require user interaction, such as approving a transaction.

### Open App Device Action

```ts
import { OpenAppDeviceAction, OpenAppDAState } from "@ledgerhq/device-management-kit";

const openAppDeviceAction = new OpenAppDeviceAction({ appName: "Bitcoin" });
const { observable, cancel } = await dmk.executeDeviceAction({ sessionId, openAppDeviceAction });

observable.subscribe({
  // Handle different states such as NotStarted, Pending, Completed, and Error
  next: (state: OpenAppDAState) => { /* Handle states */ }
});
```

### Example in React

See the [sample app](https://github.com/LedgerHQ/device-sdk-ts/tree/develop/apps/sample) for comprehensive examples showcasing the Device Management Kit's usage in React applications.
